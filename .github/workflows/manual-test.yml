name: Manual Test

# Allow manual triggering for testing
on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - build-only
        - test-only
        - lint-only
        - skip-simulation
      debug_mode:
        description: 'Enable debug output'
        required: false
        default: false
        type: boolean

env:
  GO_VERSION: '1.21'

jobs:
  manual-test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Set up Go (for debug helper)
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Debug info
      if: ${{ inputs.debug_mode }}
      env:
        TEST_TYPE: ${{ inputs.test_type }}
        DEBUG_MODE: ${{ inputs.debug_mode }}
      run: |
        cd tools/debug-helper
        go build -o debug-helper .
        ./debug-helper debug-info
        
    - name: Simulate skip scenario
      if: ${{ inputs.test_type == 'skip-simulation' }}
      run: |
        cd tools/debug-helper
        if [ ! -f debug-helper ]; then
          go build -o debug-helper .
        fi
        ./debug-helper skip-simulation
    - name: Build Go packages only
      if: ${{ inputs.test_type == 'build-only' || inputs.test_type == 'full' }}
      run: |
        cd tools/debug-helper
        if [ ! -f debug-helper ]; then
          go build -o debug-helper .
        fi
        ./debug-helper build-only
        
    - name: Run Go tests only  
      if: ${{ inputs.test_type == 'test-only' || inputs.test_type == 'full' }}
      run: |
        cd tools/debug-helper
        if [ ! -f debug-helper ]; then
          go build -o debug-helper .
        fi
        ./debug-helper test-only
        
    - name: Run Go linting only
      if: ${{ inputs.test_type == 'lint-only' || inputs.test_type == 'full' }}
      run: |
        cd tools/debug-helper
        if [ ! -f debug-helper ]; then
          go build -o debug-helper .
        fi
        ./debug-helper lint-only
        
    - name: Performance summary
      run: |
        echo "## [SUMMARY] Performance Summary" >> $GITHUB_STEP_SUMMARY
        echo "Test type: **${{ inputs.test_type }}**" >> $GITHUB_STEP_SUMMARY
        echo "Completed in: **$(date)**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### [INFO] Performance Benefits" >> $GITHUB_STEP_SUMMARY
        echo "- **Caching**: Go modules, ANTLR, tools cached" >> $GITHUB_STEP_SUMMARY
        echo "- **Parallel execution**: Build, test, lint run simultaneously" >> $GITHUB_STEP_SUMMARY
        echo "- **Smart skipping**: Non-Go changes complete in seconds" >> $GITHUB_STEP_SUMMARY
        echo "- **Consolidated**: Single workflow vs 3 separate workflows" >> $GITHUB_STEP_SUMMARY
